{
  "version": "2",
  "mpp-vars": {
    "arch": "x86_64",
    "ostree_ref": "cs8/$arch/osbuild",
    "image_size": "8589934592",
    "rootfs_uuid": "76a22bf4-f153-4541-b6c7-0332c0dfaeac",
    "bootfs_uuid": "156f0420-627b-4151-ae6f-fda298097515"
  },
  "mpp-define-image": {
    "size": "$image_size",
    "table": {
      "uuid": "D209C89E-EA5E-4FBD-B161-B461CCE297E0",
      "label": "dos",
      "partitions": [
        {
          "id": "efi",
          "size": 204800,
          "type": "ef",
          "uuid": "68B2905B-DF3E-4FB3-80FA-49D1E773AA33"
        },
        {
          "id": "boot",
          "size": 409600,
          "type": "83",
          "uuid": "61B2905B-DF3E-4FB3-80FA-49D1E773AA32"
        },
        {
          "id": "root",
          "type": "83",
          "uuid": "6264D520-3FB9-423F-8AB8-7A0A8E3D3562"
        }
      ]
    }
  },
  "pipelines": [
    {
      "mpp-import-pipeline": {
        "path": "../cs8-build-$arch.mpp.json",
        "id": "build"
      },
      "runner": "org.osbuild.centos8"
    },
    {
      "name": "ostree-tree",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.kernel-cmdline",
          "options": {
            "root_fs_uuid": {"mpp-format-string": "{rootfs_uuid}"},
            "kernel_opts": "ro biosdevname=0 net.ifnames=0"
          }
        },
        {
          "type": "org.osbuild.rpm",
          "options": {
            "gpgkeys": [
              { "mpp-format-string": "{centos_gpg_key}" },
              { "mpp-format-string": "{redhat_gpg_key}" }
            ],
            "disable_dracut": true
          },
          "inputs": {
            "packages": {
              "type": "org.osbuild.files",
              "origin": "org.osbuild.source",
              "mpp-depsolve": {
                "architecture": "$arch",
                "module-platform-id": "platform:el8",
                "baseurl": "$cs8_baseurl/BaseOS/$arch/os/",
                "repos": [
                  {
                    "id": "default",
                    "baseurl": "$cs8_baseurl/BaseOS/$arch/os/"
                  },
                  {
                    "id": "appstream",
                    "baseurl": "$cs8_baseurl/AppStream/$arch/os/"
                  },
                  {
                    "id": "extras",
                    "baseurl": "$cs8_baseurl/extras/$arch/os/"
                  },
                  {
                    "id": "copr-neptune",
                    "baseurl": "https://download.copr.fedorainfracloud.org/results/pingou/qtappmanager-fedora/centos-stream-8-$arch/"
                  }
                ],
                "packages": [
                  "NetworkManager-tui",
                  "at-spi2-atk",
                  "at-spi2-core",
                  "audit",
                  "authselect",
                  "avahi",
                  "bash",
                  "c-ares",
                  "chrome-gnome-shell",
                  "chrony",
                  "cloud-utils-growpart",
                  "cronie",
                  "cronie-anacron",
                  "dbus-daemon",
                  "dconf",
                  "dnf-plugins-core",
                  "dracut-config-generic",
                  "efi-filesystem",
                  "efibootmgr",
                  "firewalld",
                  "gdm",
                  "glib-networking",
                  "glibc-langpack-en",
                  "gnome-backgrounds",
                  "gnome-bluetooth",
                  "gnome-control-center",
                  "gnome-disk-utility",
                  "gnome-session-xsession",
                  "gnome-settings-daemon",
                  "gnome-shell",
                  "gnome-system-monitor",
                  "gnome-terminal",
                  "greenboot",
                  "greenboot-grub2",
                  "greenboot-rpm-ostree-grub2",
                  "greenboot-reboot",
                  "greenboot-status",
                  "grub2-efi-x64",
                  "gvfs-afc",
                  "gvfs-afp",
                  "gvfs-archive",
                  "gvfs-fuse",
                  "gvfs-goa",
                  "gvfs-gphoto2",
                  "gvfs-mtp",
                  "gvfs-smb",
                  "hostname",
                  "iprutils",
                  "ipset",
                  "ipset-libs",
                  "iptables",
                  "iptables-ebtables",
                  "kernel-core",
                  "kernel-modules",
                  "kernel-tools",
                  "kexec-tools",
                  "langpacks-en",
                  "less",
                  "libcanberra-gtk3",
                  "libproxy-webkitgtk4",
                  "librsvg2",
                  "libsane-hpaio",
                  "lshw",
                  "lsscsi",
                  "lzo",
                  "man-db",
                  "mesa-dri-drivers",
                  "mesa-libEGL",
                  "nautilus",
                  "nftables",
                  "neptune3-ui",
                  "nss-altfiles",
                  "openssh-clients",
                  "openssh-server",
                  "orca",
                  "ostree-grub2",
                  "passwd",
                  "plymouth",
                  "plymouth-core-libs",
                  "plymouth-scripts",
                  "polkit",
                  "rng-tools",
                  "rootfiles",
                  "rsyslog",
                  "selinux-policy-targeted",
                  "sg3_utils",
                  "snappy",
                  "squashfs-tools",
                  "sudo",
                  "systemd-udev",
                  "vim-minimal",
                  "xdg-desktop-portal",
                  "xdg-desktop-portal",
                  "xdg-desktop-portal-gtk",
                  "xdg-desktop-portal-gtk",
                  "xdg-user-dirs-gtk",
                  "yelp",
                  "yum"
                ],
                "excludes": [
                  "dracut-config-rescue"
                ]
              }
            }
          }
        },
        {
          "type": "org.osbuild.dracut",
          "options": {
            "kernel": [
              { "mpp-format-string": "{rpms['ostree-tree']['kernel-core'].evra}" }
            ],
            "add_modules": [
              "base",
              "bash",
              "dracut-systemd",
              "fs-lib",
              "i18n",
              "kernel-modules",
              "kernel-modules-extra",
              "rootfs-block",
              "shutdown",
              "systemd",
              "systemd-initrd",
              "terminfo",
              "udev-rules",
              "usrmount"
            ],
            "add_drivers": [
              "bcm2835",
              "sdhci"
            ],
            "install": [
              "/.buildstamp"
            ]
          }
        },
        {
          "type": "org.osbuild.locale",
          "options": {
            "language": "en_US.UTF-8"
          }
        },
        {
          "type": "org.osbuild.users",
          "options": {
            "users": {
              "root": {
                "password": "$6$xoLqEUz0cGGJRx01$H3H/bFm0myJPULNMtbSsOFd/2BnHqHkMD92Sfxd.EKM9hXTWSmELG8cf205l6dktomuTcgKGGtGDgtvHVXSWU."
              },
              "guest": {
                "password": "$6$xoLqEUz0cGGJRx01$H3H/bFm0myJPULNMtbSsOFd/2BnHqHkMD92Sfxd.EKM9hXTWSmELG8cf205l6dktomuTcgKGGtGDgtvHVXSWU."
              }
            }
          }
        },
        {
          "type": "org.osbuild.systemd",
          "options": {
            "enabled_services": [
              "NetworkManager.service",
              "firewalld.service",
              "rngd.service",
              "sshd.service",
              "greenboot-grub2-set-counter.service",
              "greenboot-grub2-set-success.service",
              "greenboot-healthcheck.service",
              "greenboot-rpm-ostree-grub2-check-fallback.service",
              "greenboot-status.service",
              "greenboot-task-runner.service"
            ]
          }
        },
        {
          "type": "org.osbuild.selinux",
          "options": {
            "file_contexts": "etc/selinux/targeted/contexts/files/file_contexts"
          }
        },
        {
          "type": "org.osbuild.ostree.preptree",
          "options": {
            "etc_group_members": [
              "wheel",
              "docker"
            ]
          }
        }
      ]
    },
    {
      "name": "ostree-commit",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.ostree.init",
          "options": {
            "path": "/repo"
          }
        },
        {
          "type": "org.osbuild.ostree.commit",
          "inputs": {
            "tree": {
              "type": "org.osbuild.tree",
              "origin": "org.osbuild.pipeline",
              "references": [
                "name:ostree-tree"
              ]
            }
          },
          "options": {
            "ref": {"mpp-format-string": "{ostree_ref}"},
            "os_version": "8"
          }
        }
      ]
    },
    {
      "name": "image-tree",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.ostree.init-fs"
        },
        {
          "type": "org.osbuild.ostree.pull",
          "options": {
            "repo": "/ostree/repo"
          },
          "inputs": {
            "commits": {
              "type": "org.osbuild.ostree",
              "origin": "org.osbuild.pipeline",
              "references": {
                "name:ostree-commit": {
                  "ref": {"mpp-format-string": "{ostree_ref}"}
                }
              }
            }
          }
        },
        {
          "type": "org.osbuild.ostree.os-init",
          "options": {
            "osname": "centos"
          }
        },
        {
          "type": "org.osbuild.ostree.config",
          "options": {
            "repo": "/ostree/repo",
            "config": {
              "sysroot": {
                "readonly": true
              }
            }
          }
        },
        {
          "type": "org.osbuild.mkdir",
          "options": {
            "paths": [
              {
                "path": "/boot/efi",
                "mode": 448
              }
            ]
          }
        },
        {
          "type": "org.osbuild.ostree.deploy",
          "options": {
            "osname": "centos",
            "ref": {"mpp-format-string": "{ostree_ref}"},
            "mounts": [
              "/boot",
              "/boot/efi"
            ],
            "rootfs": {
              "label": "root"
            },
            "kernel_opts": [
              "console=tty0",
              "console=ttyS0",
              "systemd.log_target=console",
              "systemd.journald.forward_to_console=1"
            ]
          }
        },
        {
          "type": "org.osbuild.ostree.fillvar",
          "options": {
            "deployment": {
              "osname": "centos",
              "ref": {"mpp-format-string": "{ostree_ref}"}
            }
          }
        },
        {
          "type": "org.osbuild.fstab",
          "options": {
            "ostree": {
              "deployment": {
                "osname": "centos",
                "ref": {"mpp-format-string": "{ostree_ref}"}
              }
            },
            "filesystems": [
              {
                "label": "boot",
                "vfs_type": "ext4",
                "path": "/boot",
                "freq": 1,
                "passno": 1
              },
              {
                "label": "root",
                "vfs_type": "xfs",
                "path": "/",
                "freq": 1,
                "passno": 1
              },
              {
                "label": "ESP",
                "vfs_type": "vfat",
                "path": "/boot/efi",
                "options": "umask=0077,shortname=winnt",
                "freq": 0,
                "passno": 2
              }
            ]
          }
        },
        {
          "type": "org.osbuild.ostree.selinux",
          "options": {
            "deployment": {
              "osname": "centos",
              "ref": {"mpp-format-string": "{ostree_ref}"}
            }
          }
        },
        {
          "type": "org.osbuild.grub2",
          "options": {
            "rootfs": {
              "label": "root"
            },
            "bootfs": {
              "label": "boot"
            },
            "uefi": {
              "vendor": "centos",
              "install": true
            },
            "legacy": "i386-pc",
            "write_defaults": false
          }
        }
      ]
    },
    {
      "name": "image",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.truncate",
          "options": {
            "filename": "disk.img",
            "size": {"mpp-format-string": "{image.size}"}
          }
        },
        {
          "type": "org.osbuild.sfdisk",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img"
              }
            }
          },
          "options": { "mpp-format-json": "{image.layout}"  }
        },
        {
          "type": "org.osbuild.mkfs.fat",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['efi'].start}"},
                "size": {"mpp-format-int": "{image.layout['efi'].size}"}
              }
            }
          },
          "options": {
            "label": "ESP",
            "volid": "7B7795E7"
          }
        },
        {
          "type": "org.osbuild.mkfs.ext4",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['boot'].start}"},
                "size": {"mpp-format-int": "{image.layout['boot'].size}"}
              }
            }
          },
          "options": {
            "uuid": {"mpp-format-string": "{bootfs_uuid}"},
            "label": "boot"
          }
        },
        {
          "type": "org.osbuild.mkfs.xfs",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['root'].start}"},
                "size": {"mpp-format-int": "{image.layout['root'].size}"}
              }
            }
          },
          "options": {
            "uuid": {"mpp-format-string": "{rootfs_uuid}"},
            "label": "root"
          }
        },
        {
          "type": "org.osbuild.copy",
          "inputs": {
            "tree": {
              "type": "org.osbuild.tree",
              "origin": "org.osbuild.pipeline",
              "references": [
                "name:image-tree"
              ]
            },
            "build-tree": {
              "type": "org.osbuild.tree",
              "origin": "org.osbuild.pipeline",
              "references": [
                "name:build"
              ]
            },
            "ostree-tree": {
              "type": "org.osbuild.tree",
              "origin": "org.osbuild.pipeline",
              "references": [
                "name:ostree-tree"
              ]
            }
          },
          "options": {
            "paths": [
              {
                "from": "input://tree/",
                "to": "mount://root/"
              }
            ]
          },
          "devices": {
            "efi": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['efi'].start}"},
                "size": {"mpp-format-int": "{image.layout['efi'].size}"}
              }
            },
            "boot": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['boot'].start}"},
                "size": {"mpp-format-int": "{image.layout['boot'].size}"}
              }
            },
            "root": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['root'].start}"},
                "size": {"mpp-format-int": "{image.layout['root'].size}"}
              }
            }
          },
          "mounts": [
            {
              "name": "root",
              "type": "org.osbuild.xfs",
              "source": "root",
              "target": "/"
            },
            {
              "name": "boot",
              "type": "org.osbuild.ext4",
              "source": "boot",
              "target": "/boot"
            },
            {
              "name": "efi",
              "type": "org.osbuild.fat",
              "source": "efi",
              "target": "/boot/efi"
            }
          ]
        }
      ]
    },
    {
      "name": "qcow2",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.qemu",
          "inputs": {
            "image": {
              "type": "org.osbuild.files",
              "origin": "org.osbuild.pipeline",
              "references": {
                "name:image": {
                  "file": "disk.img"
                }
              }
            }
          },
          "options": {
            "filename": "disk.qcow2",
            "format": {
              "type": "qcow2",
              "compat": "1.1"
            }
          }
        }
      ]
    }
  ]
}

{
  "version": "2",
  "pipelines": [
    {
      "name": "ostree-tree",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.copy",
          "inputs": {
            "tree": {
              "type": "org.osbuild.tree",
              "origin": "org.osbuild.pipeline",
              "references": [
                "name:rootfs"
              ]
            }
          },
          "options": {
            "paths": [
              {
                "from": "input://tree/",
                "to": "tree:///"
              }
            ]
          }
        },
        {
          "type": "org.osbuild.selinux",
          "options": {
            "file_contexts": "etc/selinux/targeted/contexts/files/file_contexts"
          }
        },
        {
          "type": "org.osbuild.ostree.preptree",
          "options": {
            "etc_group_members": [
              "wheel",
              "docker"
            ]
          }
        }
      ]
    },
    {
      "name": "ostree-commit",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.ostree.init",
          "options": {
            "path": "/repo"
          }
        },
        {
          "type": "org.osbuild.ostree.commit",
          "inputs": {
            "tree": {
              "type": "org.osbuild.tree",
              "origin": "org.osbuild.pipeline",
              "references": [
                "name:ostree-tree"
              ]
            }
          },
          "options": {
            "ref": {"mpp-format-string": "{ostree_ref}"},
            "os_version": "8"
          }
        }
      ]
    },
    {
      "name": "ostree-image-tree",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.ostree.init-fs"
        },
        {
          "type": "org.osbuild.ostree.pull",
          "options": {
            "repo": "/ostree/repo"
          },
          "inputs": {
            "commits": {
              "type": "org.osbuild.ostree",
              "origin": "org.osbuild.pipeline",
              "references": {
                "name:ostree-commit": {
                  "ref": {"mpp-format-string": "{ostree_ref}"}
                }
              }
            }
          }
        },
        {
          "type": "org.osbuild.ostree.os-init",
          "options": {
            "osname": "centos"
          }
        },
        {
          "type": "org.osbuild.ostree.config",
          "options": {
            "repo": "/ostree/repo",
            "config": {
              "sysroot": {
                "readonly": true
              }
            }
          }
        },
        {
          "type": "org.osbuild.mkdir",
          "options": {
            "paths": [
              {
                "path": "/boot/efi",
                "mode": 448
              }
            ]
          }
        },
        {
          "type": "org.osbuild.ostree.deploy",
          "options": {
            "osname": "centos",
            "ref": {"mpp-format-string": "{ostree_ref}"},
            "mounts": [
              "/boot",
              "/boot/efi"
            ],
            "rootfs": {
              "label": "root"
            },
            "kernel_opts": [
              "console=tty0",
              "console=ttyS0",
              "systemd.log_target=console",
              "systemd.journald.forward_to_console=1"
            ]
          }
        },
        {
          "type": "org.osbuild.ostree.fillvar",
          "options": {
            "deployment": {
              "osname": "centos",
              "ref": {"mpp-format-string": "{ostree_ref}"}
            }
          }
        },
        {
          "type": "org.osbuild.fstab",
          "options": {
            "ostree": {
              "deployment": {
                "osname": "centos",
                "ref": {"mpp-format-string": "{ostree_ref}"}
              }
            },
            "filesystems": [
              {
                "label": "boot",
                "vfs_type": "ext4",
                "path": "/boot",
                "freq": 1,
                "passno": 1
              },
              {
                "label": "root",
                "vfs_type": "xfs",
                "path": "/",
                "freq": 1,
                "passno": 1
              },
              {
                "label": "ESP",
                "vfs_type": "vfat",
                "path": "/boot/efi",
                "options": "umask=0077,shortname=winnt",
                "freq": 0,
                "passno": 2
              }
            ]
          }
        },
        {
          "type": "org.osbuild.ostree.selinux",
          "options": {
            "deployment": {
              "osname": "centos",
              "ref": {"mpp-format-string": "{ostree_ref}"}
            }
          }
        },
        {
          "type": "org.osbuild.grub2",
          "options": {
            "rootfs": {
              "label": "root"
            },
            "bootfs": {
              "label": "boot"
            },
            "uefi": {
              "vendor": "centos",
              "install": true
            },
            "legacy": {"mpp-format-json": "{grub_legacy}"},
            "write_defaults": false
          }
        }
      ]
    },
    {
      "name": "ostree-image",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.truncate",
          "options": {
            "filename": "disk.img",
            "size": {"mpp-format-string": "{image.size}"}
          }
        },
        {
          "type": "org.osbuild.sfdisk",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img"
              }
            }
          },
          "options": { "mpp-format-json": "{image.layout}"  }
        },
        {
          "type": "org.osbuild.mkfs.fat",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['efi'].start}"},
                "size": {"mpp-format-int": "{image.layout['efi'].size}"}
              }
            }
          },
          "options": {
            "label": "ESP",
            "volid": "7B7795E7"
          }
        },
        {
          "type": "org.osbuild.mkfs.ext4",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['boot'].start}"},
                "size": {"mpp-format-int": "{image.layout['boot'].size}"}
              }
            }
          },
          "options": {
            "uuid": {"mpp-format-string": "{bootfs_uuid}"},
            "label": "boot"
          }
        },
        {
          "type": "org.osbuild.mkfs.xfs",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['root'].start}"},
                "size": {"mpp-format-int": "{image.layout['root'].size}"}
              }
            }
          },
          "options": {
            "uuid": {"mpp-format-string": "{rootfs_uuid}"},
            "label": "root"
          }
        },
        {
          "type": "org.osbuild.copy",
          "inputs": {
            "tree": {
              "type": "org.osbuild.tree",
              "origin": "org.osbuild.pipeline",
              "references": [
                "name:ostree-image-tree"
              ]
            }
          },
          "options": {
            "paths": [
              {
                "from": "input://tree/",
                "to": "mount://root/"
              }
            ]
          },
          "devices": {
            "efi": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['efi'].start}"},
                "size": {"mpp-format-int": "{image.layout['efi'].size}"}
              }
            },
            "boot": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['boot'].start}"},
                "size": {"mpp-format-int": "{image.layout['boot'].size}"}
              }
            },
            "root": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-format-int": "{image.layout['root'].start}"},
                "size": {"mpp-format-int": "{image.layout['root'].size}"}
              }
            }
          },
          "mounts": [
            {
              "name": "root",
              "type": "org.osbuild.xfs",
              "source": "root",
              "target": "/"
            },
            {
              "name": "boot",
              "type": "org.osbuild.ext4",
              "source": "boot",
              "target": "/boot"
            },
            {
              "name": "efi",
              "type": "org.osbuild.fat",
              "source": "efi",
              "target": "/boot/efi"
            }
          ]
        }
      ]
    },
    {
      "name": "ostree-qcow2",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.qemu",
          "inputs": {
            "image": {
              "type": "org.osbuild.files",
              "origin": "org.osbuild.pipeline",
              "references": {
                "name:ostree-image": {
                  "file": "disk.img"
                }
              }
            }
          },
          "options": {
            "filename": "disk.qcow2",
            "format": {
              "type": "qcow2",
              "compat": "1.1"
            }
          }
        }
      ]
    }
  ]
}

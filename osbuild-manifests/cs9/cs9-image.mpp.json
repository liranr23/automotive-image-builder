{
  "version": "2",
  "pipelines": [
    {
      "name": "image",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.truncate",
          "options": {
            "filename": "disk.img",
            "size": {"mpp-eval": "image.size"}
          }
        },
        {
          "type": "org.osbuild.sfdisk",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img"
              }
            }
          },
          "options": { "mpp-format-json": "{image.layout}"  }
        },
        {
          "type": "org.osbuild.mkfs.fat",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-eval": "image.layout['efi'].start"},
                "size": {"mpp-eval": "image.layout['efi'].size"}
              }
            }
          },
          "options": {
            "label": "ESP",
            "volid": "7B7795E7"
          }
        },
        {
          "type": "org.osbuild.mkfs.ext4",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-eval": "image.layout['boot'].start"},
                "size": {"mpp-eval": "image.layout['boot'].size"}
              }
            }
          },
          "options": {
            "uuid": {"mpp-eval": "bootfs_uuid"},
            "label": "boot"
          }
        },
        {
          "type": "org.osbuild.mkfs.ext4",
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-eval": "image.layout['root'].start"},
                "size": {"mpp-eval": "image.layout['root'].size"}
              }
            }
          },
          "options": {
            "uuid": {"mpp-eval": "rootfs_uuid"},
            "label": "root"
          }
        },
        {
          "type": "org.osbuild.copy",
          "inputs": {
            "tree": {
              "type": "org.osbuild.tree",
              "origin": "org.osbuild.pipeline",
              "references": [
                "name:image-tree"
              ]
            },
            "build-tree": {
              "type": "org.osbuild.tree",
              "origin": "org.osbuild.pipeline",
              "references": [
                "name:build"
              ]
            },
            "ostree-tree": {
              "type": "org.osbuild.tree",
              "origin": "org.osbuild.pipeline",
              "references": [
                "name:ostree-tree"
               ]
             }
          },
          "options": {
            "paths": { "mpp-join": [
              [
                {
                  "from": "input://tree/",
                  "to": "mount://root/"
                }
              ],
              { "mpp-eval": "locals().get('extra_image_copy', [])" },
              { "mpp-eval": "locals().get('extra_image_copy_' + image_type, [])"}
            ]}
          },
          "devices": {
            "efi": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-eval": "image.layout['efi'].start"},
                "size": {"mpp-eval": "image.layout['efi'].size"}
              }
            },
            "boot": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-eval": "image.layout['boot'].start"},
                "size": {"mpp-eval": "image.layout['boot'].size"}
              }
            },
            "root": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.img",
                "start": {"mpp-eval": "image.layout['root'].start"},
                "size": {"mpp-eval": "image.layout['root'].size"}
              }
            }
          },
          "mounts": [
            {
              "name": "root",
              "type": "org.osbuild.ext4",
              "source": "root",
              "target": "/"
            },
            {
              "name": "boot",
              "type": "org.osbuild.ext4",
              "source": "boot",
              "target": "/boot"
            },
            {
              "name": "efi",
              "type": "org.osbuild.fat",
              "source": "efi",
              "target": "/boot/efi"
            }
          ]
        }
      ]
    },
    {
      "name": "qcow2",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.qemu",
          "inputs": {
            "image": {
              "type": "org.osbuild.files",
              "origin": "org.osbuild.pipeline",
              "references": {
                "name:image": {
                  "file": "disk.img"
                }
              }
            }
          },
          "options": {
            "filename": "disk.qcow2",
            "format": {
              "type": "qcow2",
              "compat": "1.1"
            }
          }
        }
      ]
    }
  ]
}
